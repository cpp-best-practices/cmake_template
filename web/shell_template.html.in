<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@TARGET_TITLE@</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@AT@xterm/xterm@AT@6.0.0/css/xterm.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1a2e;
            color: #eee;
            font-family: monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #container {
            max-width: 900px;
            width: 100%;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #e94560;
        }

        #terminal {
            margin: 0 auto;
            border: 2px solid #e94560;
            background-color: #0f0f23;
        }

        #loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid #16213e;
            border-top: 4px solid #e94560;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error {
            display: none;
            background-color: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Service worker for COOP/COEP headers on GitHub Pages -->
    <script src="coi-serviceworker.min.js"></script>

    <div id="container">
        <h1>@TARGET_NAME@</h1>

        <div id="loading">
            <div class="spinner"></div>
            <p>Loading @TARGET_NAME@...</p>
            <p id="progress"></p>
        </div>

        <div id="terminal" class="hidden"></div>

        <div id="error"></div>

        <div id="usage-info" style="margin-top: 30px; padding: 20px; background-color: #16213e; border-radius: 8px; font-size: 13px; line-height: 1.6;">
            <h3 style="color: #e94560; margin-bottom: 15px;">Command-Line Arguments via URL</h3>
            <p style="margin-bottom: 10px;">Pass command-line arguments to the application using URL parameters:</p>

            <div style="margin-bottom: 15px;">
                <strong style="color: #e94560;">Conversion Rules:</strong>
                <ul style="list-style: none; padding-left: 0; margin-top: 5px;">
                    <li>• Single-character params → short flags: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?v</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">-v</code></li>
                    <li>• Multi-character params → long flags: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?version</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">--version</code></li>
                    <li>• Params with values: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?file=test.txt</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">--file test.txt</code></li>
                    <li>• Multiple params: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?v&help</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">-v --help</code></li>
                </ul>
            </div>

            <div>
                <strong style="color: #e94560;">Examples:</strong>
                <ul style="list-style: none; padding-left: 0; margin-top: 5px; color: #888;">
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?version</code></li>
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?h</code></li>
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?file=data.txt</code></li>
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?verbose&config=settings.json</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Define Module configuration FIRST (synchronously, before Emscripten loads)
        // This must be in a regular script tag, not an ES module, because ES modules
        // execute asynchronously and Emscripten needs Module to exist immediately.
        var Module = {
            // Parse URL parameters and convert to CLI-style arguments
            // Single char params → short flags (?v → -v), multi-char → long flags (?version → --version)
            arguments: (function() {
                const args = [];
                new URLSearchParams(window.location.search).forEach((value, key) => {
                    args.push((key.length === 1 ? '-' : '--') + key);
                    if (value) args.push(value);
                });
                console.log('Module.arguments:', args);
                return args;
            })(),

            preRun: [],
            postRun: [],
            print: function(text) {
                console.log(text);
            },
            printErr: function(text) {
                console.error(text);
            },
            setStatus: function(text) {
                var progress = document.getElementById('progress');
                if (progress) {
                    progress.textContent = text || '';
                }
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                if (left) {
                    Module.setStatus('Loading... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')');
                } else {
                    Module.setStatus('');
                }
            },
            onRuntimeInitialized: function() {
                console.log('WASM runtime initialized');
            }
        };

        Module.setStatus('Downloading...');
    </script>

    <script type="importmap">
    {
        "imports": {
            "@xterm/xterm": "https://cdn.jsdelivr.net/npm/@AT@xterm/xterm@AT@6.0.0/+esm",
            "@xterm/addon-fit": "https://cdn.jsdelivr.net/npm/@AT@xterm/addon-fit@AT@0.11.0/+esm",
            "@xterm/addon-webgl": "https://cdn.jsdelivr.net/npm/@AT@xterm/addon-webgl@AT@0.18.0/+esm"
        }
    }
    </script>
    <script type="module">
        import { Terminal } from '@xterm/xterm';
        import { FitAddon } from '@xterm/addon-fit';
        import { WebglAddon } from '@xterm/addon-webgl';

        // Initialize xterm.js terminal
        var term = new Terminal({
            cols: 80,
            rows: 35,
            theme: {
                background: '#0f0f23',
                foreground: '#eee',
                cursor: '#e94560'
            },
            fontFamily: '"DejaVu Sans Mono", "Fira Code", "Consolas", "Monaco", monospace',
            fontSize: 14,
            lineHeight: 1.0,
            cursorBlink: false,
            convertEol: true,
            allowTransparency: false
        });

        var fitAddon = new FitAddon();
        term.loadAddon(fitAddon);

        // Try to use WebGL for better rendering (falls back gracefully)
        try {
            var webglAddon = new WebglAddon();
            webglAddon.onContextLoss(function() {
                webglAddon.dispose();
            });
            term.loadAddon(webglAddon);
            console.log('WebGL addon loaded');
        } catch (e) {
            console.log('WebGL addon not available, using canvas renderer');
        }

        // Buffers for stdin/stdout/stderr
        var stdin_buffer = [];
        var stdout_buffer = [];
        var stderr_buffer = [];

        // stdin: return next character or 0 if empty
        function stdin() {
            return stdin_buffer.shift() || 0;
        }

        // Factory function to create buffered output writers
        function createBufferWriter(buffer, writeHandler) {
            return function(code) {
                if (code === 0 || code === 10) {
                    if (code === 10) buffer.push(code);  // Include newline in buffer
                    if (buffer.length > 0) {
                        var text = new TextDecoder().decode(new Uint8Array(buffer));
                        writeHandler(text);
                        buffer.length = 0;  // Clear buffer
                    }
                } else {
                    buffer.push(code);
                }
            };
        }

        // stdout: buffer bytes, flush to terminal on null or newline
        var stdout = createBufferWriter(stdout_buffer, function(text) {
            term.write(text);
        });

        // stderr: buffer bytes, flush to console and terminal on null or newline
        var stderr = createBufferWriter(stderr_buffer, function(text) {
            console.error(text);
            term.write(text);
        });

        // Hook into Module's preRun to set up terminal before WASM starts
        Module.preRun.push(function() {
            // Set up terminal
            var terminalDiv = document.getElementById('terminal');
            terminalDiv.classList.remove('hidden');
            term.open(terminalDiv);

            // Clear terminal and reset cursor position
            term.clear();
            term.write('\x1b[H\x1b[2J');

            // Capture keyboard input -> stdin buffer
            term.onData(function(data) {
                // Filter out Cursor Position Report responses: ESC[<row>;<col>R
                // These are terminal responses to queries, not user input
                var filtered = data.replace(/\x1b\[[0-9]+;[0-9]+R/g, '');

                for (var i = 0; i < filtered.length; i++) {
                    stdin_buffer.push(filtered.charCodeAt(i));
                }
            });

            // Initialize Emscripten filesystem with our stdin/stdout/stderr
            FS.init(stdin, stdout, stderr);
        });

        // Hook into Module's postRun to finish setup after WASM loads
        Module.postRun.push(function() {
            document.getElementById('loading').classList.add('hidden');

            // Set up resize observer for FTXUI's resize callback
            if (Module._ftxui_on_resize) {
                var resizeObserver = new ResizeObserver(function() {
                    fitAddon.fit();
                    Module._ftxui_on_resize(term.cols, term.rows);
                });
                resizeObserver.observe(document.getElementById('terminal'));
            }
        });

        // Consolidated error display helper
        function showError(message, details) {
            var errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Error: ' + message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').classList.add('hidden');
            if (details) console.error(message, details);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            showError(message, { source: source, lineno: lineno, colno: colno, error: error });
        };

        window.addEventListener('unhandledrejection', function(event) {
            showError(event.reason);
        });

        // Export to window for debugging
        window.term = term;
        window.fitAddon = fitAddon;
    </script>
    {{{ SCRIPT }}}
</body>
</html>
