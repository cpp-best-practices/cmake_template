<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intro - FTXUI Sample</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@6.0.0/css/xterm.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1a2e;
            color: #eee;
            font-family: monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #container {
            max-width: 900px;
            width: 100%;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #e94560;
        }

        #terminal {
            margin: 0 auto;
            border: 2px solid #e94560;
            background-color: #0f0f23;
        }

        #loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid #16213e;
            border-top: 4px solid #e94560;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error {
            display: none;
            background-color: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Service worker for COOP/COEP headers on GitHub Pages -->
    <script src="coi-serviceworker.min.js"></script>

    <div id="container">
        <h1>Intro</h1>

        <div id="loading">
            <div class="spinner"></div>
            <p>Loading application...</p>
            <p id="progress"></p>
        </div>

        <div id="terminal" class="hidden"></div>

        <div id="error"></div>

        <div id="usage-info" style="margin-top: 30px; padding: 20px; background-color: #16213e; border-radius: 8px; font-size: 13px; line-height: 1.6;">
            <h3 style="color: #e94560; margin-bottom: 15px;">Command-Line Arguments via URL</h3>
            <p style="margin-bottom: 10px;">Pass command-line arguments to the application using URL parameters:</p>

            <div style="margin-bottom: 15px;">
                <strong style="color: #e94560;">Conversion Rules:</strong>
                <ul style="list-style: none; padding-left: 0; margin-top: 5px;">
                    <li>• Single-character params → short flags: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?v</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">-v</code></li>
                    <li>• Multi-character params → long flags: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?version</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">--version</code></li>
                    <li>• Params with values: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?file=test.txt</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">--file test.txt</code></li>
                    <li>• Multiple params: <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">?v&help</code> → <code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">-v --help</code></li>
                </ul>
            </div>

            <div>
                <strong style="color: #e94560;">Examples:</strong>
                <ul style="list-style: none; padding-left: 0; margin-top: 5px; color: #888;">
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?version</code></li>
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?h</code></li>
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?file=data.txt</code></li>
                    <li><code style="background-color: #0f0f23; padding: 2px 6px; border-radius: 3px;">intro.html?verbose&config=settings.json</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@6.0.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0.18.0/lib/addon-webgl.min.js"></script>
    <script>
        // Initialize xterm.js terminal
        // Use a monospace font with good Unicode block character support
        var term = new Terminal({
            cols: 80,
            rows: 35,
            theme: {
                background: '#0f0f23',
                foreground: '#eee',
                cursor: '#e94560'
            },
            fontFamily: '"DejaVu Sans Mono", "Fira Code", "Consolas", "Monaco", monospace',
            fontSize: 14,
            lineHeight: 1.0,
            cursorBlink: false,
            convertEol: true,
            allowTransparency: false
        });

        var fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        // Try to use WebGL for better rendering (falls back gracefully)
        try {
            var webglAddon = new WebglAddon.WebglAddon();
            webglAddon.onContextLoss(function() {
                webglAddon.dispose();
            });
            term.loadAddon(webglAddon);
            console.log('WebGL addon loaded');
        } catch (e) {
            console.log('WebGL addon not available, using canvas renderer');
        }

        // Buffers for stdin/stdout/stderr
        var stdin_buffer = [];
        var stdout_buffer = [];
        var stderr_buffer = [];

        // stdin: return next character or 0 if empty
        function stdin() {
            return stdin_buffer.shift() || 0;
        }

        // stdout: buffer bytes, flush on null byte (0) or newline (10)
        function stdout(code) {
            if (code === 0 || code === 10) {
                // Flush buffer to terminal
                if (code === 10) {
                    stdout_buffer.push(code);  // Include the newline
                }
                if (stdout_buffer.length > 0) {
                    var text = new TextDecoder().decode(new Uint8Array(stdout_buffer));
                    term.write(text);
                    stdout_buffer = [];
                }
            } else {
                stdout_buffer.push(code);
            }
        }

        // stderr: buffer bytes, flush on null or newline
        function stderr(code) {
            if (code === 0 || code === 10) {
                if (stderr_buffer.length > 0) {
                    var text = new TextDecoder().decode(new Uint8Array(stderr_buffer));
                    console.error(text);
                    // Also write to visible terminal so users can see errors
                    term.write(text);
                    stderr_buffer = [];
                }
            } else {
                stderr_buffer.push(code);
            }
        }

        var Module = {
            // Parse URL parameters and convert to CLI-style arguments
            arguments: (function() {
                const args = [];
                const urlParams = new URLSearchParams(window.location.search);

                // Convert all URL parameters to command-line arguments
                for (const [key, value] of urlParams.entries()) {
                    // Single character params become short flags: ?v → -v
                    // Multi-character params become long flags: ?version → --version
                    const prefix = key.length === 1 ? '-' : '--';

                    if (value === '' || value === null) {
                        // Boolean flag without value: ?help → --help
                        args.push(prefix + key);
                    } else {
                        // Parameter with value: ?file=test.txt → --file test.txt
                        args.push(prefix + key);
                        args.push(value);
                    }
                }

                console.log('Module.arguments:', args);
                return args;
            })(),

            preRun: [function() {
                // Set up terminal
                var terminalDiv = document.getElementById('terminal');
                terminalDiv.classList.remove('hidden');
                term.open(terminalDiv);

                // Clear terminal and reset cursor position
                term.clear();
                term.write('\x1b[H\x1b[2J');

                // Capture keyboard input -> stdin buffer
                term.onData(function(data) {
                    // Filter out Cursor Position Report responses: ESC[<row>;<col>R
                    // These are terminal responses to queries, not user input
                    var filtered = data.replace(/\x1b\[[0-9]+;[0-9]+R/g, '');

                    for (var i = 0; i < filtered.length; i++) {
                        stdin_buffer.push(filtered.charCodeAt(i));
                    }
                });

                // Initialize Emscripten filesystem with our stdin/stdout/stderr
                FS.init(stdin, stdout, stderr);
            }],
            postRun: [function() {
                document.getElementById('loading').classList.add('hidden');

                // Set up resize observer for FTXUI's resize callback
                if (window.Module._ftxui_on_resize) {
                    var resizeObserver = new ResizeObserver(function() {
                        fitAddon.fit();
                        window.Module._ftxui_on_resize(term.cols, term.rows);
                    });
                    resizeObserver.observe(document.getElementById('terminal'));
                }
            }],
            print: function(text) {
                console.log(text);
            },
            printErr: function(text) {
                console.error(text);
            },
            setStatus: function(text) {
                var progress = document.getElementById('progress');
                if (progress) {
                    progress.textContent = text || '';
                }
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                if (left) {
                    Module.setStatus('Loading... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')');
                } else {
                    Module.setStatus('');
                }
            },
            onRuntimeInitialized: function() {
                console.log('WASM runtime initialized');
            }
        };

        Module.setStatus('Downloading...');

        window.onerror = function(message, source, lineno, colno, error) {
            var errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Error: ' + message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').classList.add('hidden');
            console.error('Error:', message, source, lineno, colno, error);
        };

        window.addEventListener('unhandledrejection', function(event) {
            var errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Error: ' + event.reason;
            errorDiv.style.display = 'block';
            document.getElementById('loading').classList.add('hidden');
            console.error('Unhandled rejection:', event.reason);
        });
    </script>
    {{{ SCRIPT }}}

    <!--
    URL Parameter to Command-Line Argument Conversion
    ==================================================

    URL parameters are automatically converted to command-line arguments
    passed to the intro executable:

    Conversion Rules:
    -----------------
    1. Single-character parameters → Short flags (with -)
       Example: ?v → -v
                ?h → -h

    2. Multi-character parameters → Long flags (with --)
       Example: ?version → --version
                ?help → --help

    3. Parameters without values → Boolean flags
       Example: ?verbose → --verbose
                ?debug → --debug

    4. Parameters with values → Flag + value (as separate arguments)
       Example: ?file=test.txt → --file test.txt
                ?config=settings.json → --config settings.json

    5. Multiple parameters → Multiple arguments
       Example: ?v&file=data.txt → -v --file data.txt

    Usage Examples:
    ---------------
    intro.html?version              → --version
    intro.html?h                    → -h
    intro.html?file=data.txt        → --file data.txt
    intro.html?v&config=app.cfg     → -v --config app.cfg
    intro.html?verbose&input=x.txt  → --verbose --input x.txt

    Note: This allows any CLI argument supported by the intro executable
    to be passed via URL parameters for web-based usage.
    -->
</body>
</html>
